name: 'build-and-deploy-spa'
description: 'Builds SPA Project for Production and Deploys it to a given SWA Environment'

inputs:
  apiUrl:
    required: true
    description: "Base URL of the API"
  oauthConfig:
    required: true
    description: "OAuthConfig from the angular-oauth2-oidc package"
  releaseVersion:
    required: true
    description: "Release Version (Commit or Tag)"
  deploymentEnv:
    required: true
    description: "Azure SWA Deployment Environment"
  publishToken:
    required: true
    description: "Azure Static Web App Deployment Token"
  sentryKey:
    required: true
    description: "Sentry DSN Key"
  sentryAuthToken:
    required: true
    description: "Sentry Auth Token"
outputs:
  url:
    description: "SPA URL"
    value: ${{ steps.spa-deployment.outputs.static_web_app_url  }}

runs:
  using: "composite"
  steps:
    - run: |
        envsubst < apps/spa/src/environments/environment.template > apps/spa/src/environments/environment.prod.ts
        npx nx build spa --prod
      shell: bash
      env:
        IS_PRODUCTION: true
        ENVIRONMENT_NAME: ${{ inputs.deploymentEnv }}
        API_URL: ${{ inputs.apiUrl }}
        OAUTH_CONFIG: ${{ inputs.oauthConfig }}
        RELEASE_VERSION: ${{ inputs.releaseVersion }}
        SENTRY_KEY: ${{ inputs.sentryKey }}
    - name: Deploy SPA
      id: spa-deployment
      uses: Azure/static-web-apps-deploy@v1
      with:
        azure_static_web_apps_api_token: ${{ inputs.publishToken }}
        action: "upload"
        app_location: "dist/apps/spa/"
        output_location: ''
        skip_app_build: true
        skip_api_build: true
        deployment_environment: ${{ inputs.deploymentEnv }}
    - name: Build SPA with source maps
      run: npx nx build spa --prod --source-map=true
      shell: bash
    - name: Create Sentry release
      uses: getsentry/action-release@v1
      env:
        SENTRY_AUTH_TOKEN: ${{ inputs.sentryAuthToken }}
        SENTRY_ORG: kordis-leitstelle
        SENTRY_PROJECT: kordis-spa
      with:
        environment: ${{ inputs.deploymentEnv }}
        version: ${{ inputs.releaseVersion }}
        sourcemaps: ./dist/apps/spa
